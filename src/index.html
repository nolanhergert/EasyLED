<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name = "viewport" content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0, user-scalable=0">


<style>

body {
  width: 400px;
}

.radio-toolbar {
  margin: 10px;
  /* Only have room for two columns */
  width: 160px;
}

.radio-toolbar input[type="radio"] {
  opacity: 0;
  position: fixed;
  width: 0;
}

.radio-toolbar label {
  display: inline-block;
  background-color: #ddd;
  font-family: sans-serif, Arial;
  font-size: 16px;
  border: 2px solid #444;
  border-radius: 4px;
  width: 40px;
  height: 40px;
  text-align: center;
}

.radio-toolbar label:hover {
  background-color: #dfd;
}

.radio-toolbar input[type="radio"]:focus + label {
  border: 2px dashed #444;
}

.radio-toolbar input[type="radio"]:checked + label {
  background-color: #bfb;
  border-color: #4c4;
}

.pair {
  margin: 10px;
  float: left;
}

/* Not seen by default */
.customizer {
  display: none;
}

.number-picker button{
  width: 30px;
  height: 30px;
  padding: 0px;
}

/*** Hide normal number input buttons ***/
/* Chrome, Safari, Edge, Opera */
.number-picker input::-webkit-outer-spin-button,
.number-picker input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
.number-picker input[type=number] {
  -moz-appearance: textfield;
}

#save {
  float: right;
  font-size: large;
}
/*****************************************/

</style>

</head>
<body>

<div>
  Brightness: 
  <input type="range" min="0" max="255" value="65" step="5" class="slider" id="brightness">
  <button type="button" id="save" value="1" disabled="true">Save Changes</button>
</div>


Pin
<div class="radio-toolbar">
  <div class="pair">
    <input type="radio" id="radioOne" name="radioPin" value="1" checked>
    <label for="radioOne">1</label>
    </br>
    <input type="radio" id="radioTwo" name="radioPin" value="2">
    <label for="radioTwo">2</label>
  </div>
  <div class="pair">
    <input type="radio" id="radioFive" name="radioPin" value="5">
    <label for="radioFive">5</label> 
    </br>
    <input type="radio" id="radioSix" name="radioPin" value="6">
    <label for="radioSix">6</label> 
  </div>
  <div class="pair">
    <input type="radio" id="radioThree" name="radioPin" value="3">
    <label for="radioThree">3</label> 
    </br>
    <input type="radio" id="radioFour" name="radioPin" value="4">
    <label for="radioFour">4</label> 
  </div>
  <div class="pair">
    <input type="radio" id="radioSeven" name="radioPin" value="7">
    <label for="radioSeven">7</label> 
    </br>
    <input type="radio" id="radioEight" name="radioPin" value="8">
    <label for="radioEight">8</label> 
  </div>  
</div>


<label>Choose a function:
  <select name="function">
    <option value="1">Animation</option>
    <!--<option value="2">Combine With</option>-->
  </select>
</label>
<p></p>

<!-- HTML classes for customizing patterns chosen -->
<div class="customizer" id="AnimationCustomizer">

  <!-- IDs: Unique; Name: used for url parameters; class: everything else? -->
  <!-- Unfortunately don't know the right way to iterate through classes-->
  <div class="number-picker">
    <label for="num_leds">Number of LEDs: </label>
    <button class="decrement">-</button>
    <input type="number" class="value" name="num_leds" min="1" max="99" value="20">
    <button class="increment
    ">+</button>
  </div>
  <p></p>

	<label>Pattern: 
	  <select name="pattern">
    <option value="1">Rainbow</option>
    <option value="2">Rainbow With Glitter</option>
		<option value="3">Color</option>
    <option value="4">Fill Noise</option>
    <option value="5">Juggle</option>
    <option value="6">Confetti</option>
    <option value="7">Sinelon</option>
    <option value="8">BPM</option>
	  </select>
	</label>

    <p></p>
	<label for="color1">Select your favorite color:</label>
	<input type="color" id="color1" name="color1" value="#ff0000">

</div>


<div class="customizer" id="CombineCustomizer">
	<label>Choose Pin: 
	  <select name="combine_pin">
		<option value="1">1</option>
		<option value="2">2</option>
		<option value="3">3</option>
		<option value="4">4</option>
		<option value="5">5</option>
		<option value="6">6</option>
		<option value="7">7</option>
		<option value="8">8</option>
	  </select>
	</label>

	<!-- Add an pattern offset input text box here? -->

</div>


<!------------------------------------------------->


<script>
let jsonFoo = `{
  "version": "00.01.00.0000",
  "writeCount": 0,
  "crc": 3578075235,
  "numPins": 8,
  "pins": [
    {
      "index": 0,
      "function": 0,
      "pattern": 7,
      "num_leds": 10,
      "offset": 0,
      "colors": [
        "#ff0000",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    },
    {
      "index": 1,
      "function": 0,
      "pattern": 6,
      "num_leds": 0,
      "offset": 0,
      "colors": [
        "#0000ff",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    },
    {
      "index": 2,
      "function": 0,
      "pattern": 5,
      "num_leds": 0,
      "offset": 0,
      "colors": [
        "#0000ff",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    },
    {
      "index": 3,
      "function": 0,
      "pattern": 0,
      "num_leds": 0,
      "offset": 0,
      "colors": [
        "#0000ff",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    },
    {
      "index": 4,
      "function": 0,
      "pattern": 0,
      "num_leds": 0,
      "offset": 0,
      "colors": [
        "#0000ff",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    },
    {
      "index": 5,
      "function": 0,
      "pattern": 0,
      "num_leds": 0,
      "offset": 0,
      "colors": [
        "#0000ff",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    },
    {
      "index": 6,
      "function": 0,
      "pattern": 0,
      "num_leds": 0,
      "offset": 0,
      "colors": [
        "#0000ff",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    },
    {
      "index": 7,
      "function": 0,
      "pattern": 0,
      "num_leds": 0,
      "offset": 0,
      "colors": [
        "#0000ff",
        "#000000",
        "#000000",
        "#000000",
        "#000000"
      ]
    }
  ]
}
`;



let settings = JSON.parse(jsonFoo);

// Get latest data on page load using JSON asyncronous request
// https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Introducing
/*
fetch('settings.json')
  .then(response => response.json())
  .then((response) => {
    console.log(response);
    console.log(response['crc']);
    settings = response;
    console.log(settings['crc']);
    pinChanged();
  });
*/

//document.getElementsByClassName("decrement").forEach(p => p.onclick = console.log("foo"));
/*
var number_pickers = document.getElementsByClassName('number-picker');
//var number_pickers = document.querySelector('#number-picker');
[].forEach.call(number_pickers, function (p) {
  p.querySelector('.decrement').onclick = p.querySelector('.value').value--;
  p.getElementsByClassName('increment')[0].onclick = p.getElementsByClassName('value')[0]++;
});
*/



// General non-customizer inputs
document.getElementById("brightness").oninput = onGeneralInput;
document.getElementById("save").onclick = onGeneralInput;


// TODO is the constructor occurring correctly?? Seems to only be 
// happening for one customizer and not iterating over all of them?
// Should probably be using class too

class AnimationCustomizer {
  constructor() {
    this.div = document.getElementById("AnimationCustomizer");
  }
  
  setup() {
	this.hide();
	this.inputs = this.div.querySelectorAll('input, textarea, select');
	// Set up onChanged callback for each input element
	// to send out the full query string for the form (for now)
	for (let input of this.inputs) {
	  // We want to use oninput() as it's live, whereas onchanged()
	  // is only after the object loses focus.
	  input.oninput = onCustomizerInput;
	}	
  }
  
  hide() {
    this.div.style.display = "none";
  }
    
  show() {
    this.div.style.display = "block";
  }
  
  publish() {
    // Unused right now
    /*
    // Send a string with the inputs in query string form
    console.log("pin", currentPin);
    console.log("function", currentFunction);
    for (let input of this.inputs) {
      console.log(input.name, input.value);
	  }
    */
  }
  
}

class CombineCustomizer extends AnimationCustomizer {
  constructor() {
    super();
    this.div = document.getElementById("CombineCustomizer");
  }
}


// Set up defaults
// TODO: Load already saved data from wemos d1 mini

var customizers = [];
var animationCustomizer = new AnimationCustomizer();
animationCustomizer.setup();
customizers.push(animationCustomizer);
/*
var combineCustomizer = new CombineCustomizer();
combineCustomizer.setup();
customizers.push(combineCustomizer);
*/


let currentPin = 1;
let activeCustomizer = customizers[0];

function pinChanged() {
  activeCustomizer.hide();
  // Set current function and customizer for the pin
  document.getElementsByName("function")[0].value = settings["pins"][currentPin-1]["function"];
  console.log("customizer index: ", settings["pins"][currentPin-1]["function"]);
  activeCustomizer = customizers[settings["pins"][currentPin-1]["function"]];
  // Set all customizer values
  for (let customizer of customizers) {
    // Set the customizer values
    for (let input of customizer.inputs) {
      if ("color1" === input.name) {
        // Hack it for now
        input.value = settings["pins"][currentPin-1]["colors"][0];
      } else {
        input.value = settings["pins"][currentPin-1][input.name];
      }
      console.log(input.name, input.value);
    }
  }
  activeCustomizer.show();
}

function onPinSelection(e) {
  currentPin = e.target.value;
  pinChanged();
}



/*

fetch('settings.json').then(function(response) {
  //return response.json();
  // Maybe this is helpful? https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/JSON
  JSON.parse();     // input  https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse
  JSON.stringify(); // output https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify
}).

*/



// Set pin handler
document.getElementsByName("radioPin").forEach(p => p.onclick = onPinSelection);

function onCustomizerInput(e) {
  // Here's some docs to handle e: https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers/oninput
  // Publish current pin and property
  // I like it for it's simplicity and efficiency. Keeping it for now
  fetch(`/set?pin=${currentPin};${e.target.name}=${e.target.value}`);
  //console.log(`/set?pin=${currentPin};${e.target.name}=${e.target.value}`);
  

  // Alternatively one could also publish all details of the
  // currently active customizer
  //activeCustomizer.publish();

  // Or publish the pin as JSON
  // JSON.stringify(settings["pins"][0])

  // Or walk up the tree just for that property
  // https://stackoverflow.com/a/61693085/931280
} 

// Probably want to refactor this and the above to be together
function onGeneralInput(e) {
  fetch(`/set?${e.target.id}=${e.target.value}`);
  //console.log(`/set?${e.target.id}=${e.target.value}`);
}




// Selector on change
const selectElement = document.querySelector('.pattern');
document.getElementsByName("function")[0].addEventListener('change', (event) => {
  // Hide current customizer
  activeCustomizer.hide();
  customizers.forEach(c => c.hide());
  activeCustomizer = customizers[event.target.value];
  activeCustomizer.show();
});

/*

Can't do without setting the size to be non-0 or non-1 and annoying! I think it's fine for mobile users

// Thanks Mozilla Dev! https://developer.mozilla.org/en-US/docs/Web/API/Element/mouseover_event
function onPatternMouseOver(e) {
  // Need to set the current pattern
  console.log(e.target.value);
  // And then publish it. Maybe only it? Hmm...
  activeCustomizer.publish();
}

// Pattern selector children (options)
// Spreader??? https://stackoverflow.com/a/35970005/931280
[...document.getElementsByName("pattern")[0].children].forEach(function (child) {
  child.onmouseover = onPatternMouseOver;
});

document.getElementsByName("pattern")[0].onmouseover = onPatternMouseOver;

*/

</script>
</body>
</html>